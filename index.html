<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… GPS Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø©</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #0d1b2a;
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 450px;
      margin: 0 auto;
    }
    header h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 24px;
    }
    .card {
      background: #1b263b;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }
    .metric {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
      color: #4cc9f0;
    }
    .label {
      color: #caf0f8;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .coord {
      font-family: monospace;
      background: #0d1b2a;
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
      direction: ltr;
      text-align: center;
      border: 1px solid #3e5c76;
      font-size: 16px;
    }
    #status {
      padding: 12px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      background: #1b263b;
      color: #ff9e00;
      border: 1px solid #4361ee;
    }
    .btn {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .btn-start { background: #2ecc71; color: white; }
    .btn-stop { background: #e74c3c; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ù†Ø¸Ø§Ù… GPS Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© (GNSS Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù…Ø§Ø±)</h1>
    </header>

    <div class="card">
      <div class="label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©</div>
      <div class="metric" id="distance">0.00 Ù…</div>

      <div class="label">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</div>
      <div class="coord" id="lat">â€”</div>

      <div class="label">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</div>
      <div class="coord" id="lng">â€”</div>

      <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©</div>
      <div class="metric" id="pointCount">0</div>

      <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±... ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ "Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>

      <button id="startBtn" class="btn btn-start">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø©</button>
      <button id="stopBtn" class="btn btn-stop" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
  </div>

  <script>
    // === Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ===
    let isTracking = false;
    let totalDistance = 0;
    let lastPosition = null;
    let validPositions = []; // Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©
    let lastGpsTime = 0;

    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© ===
    const UPDATE_INTERVAL = 800;        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 0.8 Ø«Ø§Ù†ÙŠØ©
    const MIN_DISTANCE_FILTER = 0.8;    // Ù…ØªØ±: Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
    const MAX_SPEED_KMH = 25;           // Ù„ØªØµÙÙŠØ© Ø§Ù„Ù‚ÙØ²Ø§Øª (Ø´Ø®Øµ Ù„Ø§ ÙŠÙ…Ø´ÙŠ Ø¨Ù€ 50 ÙƒÙ…/Ø³!)

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const distanceEl = document.getElementById('distance');
    const latEl = document.getElementById('lat');
    const lngEl = document.getElementById('lng');
    const pointCountEl = document.getElementById('pointCount');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    // === Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine) ===
    function haversine(p1, p2) {
      const R = 6371000;
      const dLat = (p2.lat - p1.lat) * Math.PI / 180;
      const dLon = (p2.lng - p1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // === ÙÙ„ØªØ± Ù…ØªÙ‚Ø¯Ù…: Ø±ÙØ¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø§Ø°Ø© (Outlier Rejection) ===
    function isOutlier(newPos, lastPos, timeDiffMs) {
      if (!lastPos) return false;
      const distance = haversine(lastPos, newPos);
      const speed = (distance / timeDiffMs) * 3600; // Ù…/Ø³Ø§Ø¹Ø© â†’ ÙƒÙ…/Ø³Ø§Ø¹Ø©
      return speed > MAX_SPEED_KMH * 1000; // ØªØ­ÙˆÙŠÙ„ ÙƒÙ…/Ø³ Ø¥Ù„Ù‰ Ù…/Ø³
    }

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© ===
    function updateGpsHighAccuracy() {
      if (!isTracking) return;
      const now = Date.now();

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const timeDiff = now - lastGpsTime;

          // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙÙˆØ±Ù‹Ø§ (Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯)
          latEl.textContent = latitude.toFixed(7);
          lngEl.textContent = longitude.toFixed(7);

          const newPosition = { lat: latitude, lng: longitude, accuracy, time: now };

          // Ø§Ù„ÙÙ„ØªØ± 1: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª ØºÙŠØ± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯Ù‹Ù‘Ø§
          if (accuracy > 20) { // Ø£ÙƒØ«Ø± Ù…Ù† 20 Ù…ØªØ± Ø¯Ù‚Ø© = ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚
            statusEl.textContent = `ğŸ“¡ Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø© (${accuracy.toFixed(1)} Ù…) â€” Ù„Ø§ ØªÙØ­Ø³Ø¨`;
            return;
          }

          // Ø§Ù„ÙÙ„ØªØ± 2: Ø±ÙØ¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø§Ø°Ø© (Ù‚ÙØ²Ø§Øª Ø³Ø±Ø¹Ø© ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ©)
          if (lastPosition && isOutlier(newPosition, lastPosition, timeDiff)) {
            statusEl.textContent = 'âš ï¸ ØªÙ… Ø±ÙØ¶ Ù†Ù‚Ø·Ø© ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ© (Ù‚ÙØ²Ø© Ø³Ø±Ø¹Ø©)';
            return;
          }

          // Ø§Ù„ÙÙ„ØªØ± 3: Ù„Ø§ Ù†Ø­Ø³Ø¨ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªØ­Ø±ÙƒÙ†Ø§ Ø£ÙƒØ«Ø± Ù…Ù† MIN_DISTANCE_FILTER
          if (lastPosition) {
            const d = haversine(lastPosition, newPosition);
            if (d >= MIN_DISTANCE_FILTER) {
              totalDistance += d;
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
              if (totalDistance >= 1000) {
                distanceEl.textContent = (totalDistance / 1000).toFixed(3) + ' ÙƒÙ…';
              } else {
                distanceEl.textContent = totalDistance.toFixed(1) + ' Ù…';
              }
              validPositions.push(newPosition);
              pointCountEl.textContent = validPositions.length;
            }
          }

          lastPosition = newPosition;
          lastGpsTime = now;
          statusEl.textContent = `âœ… Ø¯Ù‚Ø©: ${accuracy.toFixed(1)} Ù… | ØªØ­Ø¯ÙŠØ« ÙƒÙ„ ${UPDATE_INTERVAL} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©`;
        },
        (error) => {
          console.error('GPS Error:', error);
          statusEl.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ GPS: ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ "Ø§Ù„ÙˆØ¶Ø¹ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø©"';
        },
        {
          enableHighAccuracy: true,   // â† Ù‡Ø°Ø§ ÙŠÙØ¹Ù‘Ù„ GNSS Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù…Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ù‘Ø§
          timeout: 10000,
          maximumAge: 0               // Ù„Ø§ Ù†Ù‚Ø¨Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
        }
      );
    }

    // === Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ===
    function startTracking() {
      if (!navigator.geolocation) {
        statusEl.textContent = 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        return;
      }

      // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ "ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©"
      statusEl.textContent = 'âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„... ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹: "Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS"';
      isTracking = true;
      totalDistance = 0;
      lastPosition = null;
      validPositions = [];
      distanceEl.textContent = '0.00 Ù…';
      pointCountEl.textContent = '0';

      startBtn.disabled = true;
      stopBtn.disabled = false;

      updateGpsHighAccuracy(); // Ø£ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø©
      gpsInterval = setInterval(updateGpsHighAccuracy, UPDATE_INTERVAL);
    }

    // === Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹ ===
    function stopTracking() {
      isTracking = false;
      clearInterval(gpsInterval);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusEl.textContent = `â¹ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù. Ø§Ù„Ù…Ø³Ø§ÙØ©: ${
        totalDistance >= 1000 ? (totalDistance/1000).toFixed(3) + ' ÙƒÙ…' : totalDistance.toFixed(1) + ' Ù…'
      } (${validPositions.length} Ù†Ù‚Ø·Ø© Ù…ÙˆØ«ÙˆÙ‚Ø©)`;
    }

    // === Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===
    let gpsInterval = null;
    startBtn.addEventListener('click', startTracking);
    stopBtn.addEventListener('click', stopTracking);
  </script>
</body>
</html>
