<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 40px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 30px;
      font-weight: 700;
    }
    .step-display {
      font-size: 6rem;
      font-weight: 800;
      margin: 20px 0;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .btn {
      background: #4cc9f0;
      color: #0d0d0d;
      border: none;
      padding: 16px 32px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #4361ee;
      color: white;
    }
    .btn:active {
      transform: scale(0.98);
    }
    .status {
      margin-top: 20px;
      font-size: 1.1rem;
      min-height: 26px;
    }
    .info {
      margin-top: 30px;
      font-size: 0.95rem;
      opacity: 0.9;
      line-height: 1.5;
    }
    @media (max-width: 480px) {
      .step-display {
        font-size: 4.5rem;
      }
      h1 {
        font-size: 1.8rem;
      }
      .btn {
        padding: 14px 28px;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª</h1>
    <div class="step-display" id="stepCount">0</div>
    <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯</button>
    <div class="status" id="status">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯</div>
    <div class="info">
      â€¢ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ ÙÙ‚Ø·<br>
      â€¢ ÙŠÙØ·Ù„Ø¨ Ù…Ù†Ùƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ "Ø§Ù„Ø­Ø±ÙƒØ©" Ø£ÙˆÙ„ Ù…Ø±Ø©<br>
      â€¢ Ù„Ø§ ÙŠØ­Ø³Ø¨ Ø§Ù„Ù‡Ø² Ø£Ùˆ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    </div>
  </div>

  <script>
    let stepCount = 0;
    let lastPeakTime = 0;
    let accelerationHistory = [];
    let isCounting = false;

    // âœ… Ø¹ØªØ¨Ø§Øª Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ù…Ø´ÙŠ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    const STEP_THRESHOLD = 1.3;      // Ø£Ù‚Ù„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø´ÙŠ Ø§Ù„Ø¨Ø·ÙŠØ¡
    const MIN_STEP_INTERVAL = 250;   // 250ms = ~240 Ø®Ø·ÙˆØ©/Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    const MAX_STEP_INTERVAL = 2000;  // 2 Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª (Ù„Ù„Ù…Ø´ÙŠ Ø§Ù„Ø¨Ø·ÙŠØ¡ Ø¬Ø¯Ù‹Ø§)
    const HISTORY_SIZE = 8;

    function updateDisplay() {
      document.getElementById('stepCount').innerText = stepCount;
    }

    function handleMotion(event) {
      if (!isCounting) return;
      
      const accel = event.accelerationIncludingGravity;
      if (!accel) return;

      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­ÙˆØ± Y (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø±Ø¨Ø© Z Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„)
      const currentAccel = Math.abs(accel.y || accel.z || 0);
      const now = Date.now();

      accelerationHistory.push({ time: now, value: currentAccel });
      if (accelerationHistory.length > HISTORY_SIZE) {
        accelerationHistory.shift();
      }

      if (accelerationHistory.length < 5) return;

      const recent = accelerationHistory.slice(-5);
      const mid = recent[2].value;
      const isPeak = (
        mid > recent[1].value &&
        mid > recent[3].value &&
        mid > STEP_THRESHOLD
      );

      if (isPeak && now - lastPeakTime > MIN_STEP_INTERVAL) {
        setTimeout(() => {
          if (!isCounting) return;
          const newAccel = Math.abs(window.lastAccel || 0);
          if (newAccel < mid - 0.3) { // ÙØ±Ù‚ Ø£ØµØºØ± Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ø´ÙŠ Ø§Ù„Ø®ÙÙŠÙ
            const stepTimeDelta = now - lastPeakTime;
            if (stepTimeDelta >= MIN_STEP_INTERVAL && stepTimeDelta <= MAX_STEP_INTERVAL) {
              stepCount++;
              lastPeakTime = now;
              updateDisplay();
              document.getElementById('status').innerText = `ğŸš¶â€â™‚ï¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª: ${stepCount}`;
            }
          }
        }, 80);
        window.lastAccel = currentAccel;
      }
    }

    function startCounting() {
      if (typeof DeviceMotionEvent === 'undefined') {
        document.getElementById('status').innerText = 'âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø³ØªØ´Ø¹Ø± Ø§Ù„Ø­Ø±ÙƒØ©';
        return;
      }

      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        // iOS 13+
        DeviceMotionEvent.requestPermission()
          .then(permission => {
            if (permission === 'granted') {
              enableTracking();
            } else {
              document.getElementById('status').innerText = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø±ÙƒØ©';
            }
          })
          .catch(err => {
            console.error(err);
            document.getElementById('status').innerText = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†';
          });
      } else {
        // Android
        enableTracking();
      }
    }

    function enableTracking() {
      isCounting = true;
      stepCount = 0;
      lastPeakTime = 0;
      accelerationHistory = [];
      updateDisplay();
      document.getElementById('status').innerText = 'âœ… Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø´ÙŠ...';
      document.getElementById('startBtn').innerText = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†';
      document.getElementById('startBtn').onclick = resetCounter;
      window.addEventListener('devicemotion', handleMotion);
    }

    function resetCounter() {
      stepCount = 0;
      lastPeakTime = Date.now();
      accelerationHistory = [];
      updateDisplay();
      document.getElementById('status').innerText = 'ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† â€” Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø´ÙŠ';
    }

    // Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø²Ø±
    document.getElementById('startBtn').addEventListener('click', startCounting);
  </script>
</body>
</html>
